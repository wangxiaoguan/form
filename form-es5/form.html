<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="content-type" content="no-cache, must-revalidate" />
    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>填报</title>
    <link rel="stylesheet" type="text/css" href="css/weui.css" />
    <link rel="stylesheet" type="text/css" href="css/validate.css">
    <style>
        html,body{
            width: 100%;
            height: 100%;
            padding: 0;
            margin:0;
        }
        #app{
            width: 100%;
            display: none;
        }
        header>img{
            width: 100%;
        }
        #form{
            height: 100%;
            padding: 0.5rem 0;
        }
        .form-item{
            /* padding-bottom: 1.4rem; */
            position: relative;
            padding: 0 1rem;
        }
        label{
            font-size: 16px;
        }
        .form-item-show{
            display: block;
        }
        .form-item-hide{
            display: none;
        }
        .field-rule{
            clear: both;
            width: calc(100% - 1rem);
            /* position: absolute; */
            /* position: relative; */
            /* left: 0; */
            /* bottom: 6px; */
            height: 1rem;
            /* margin: 0 0.5rem; */
            font-size: 0.75rem;
            /* line-height: 1.6rem; */
            color: #ff0000;
            text-indent: 1rem;
        }
        .field-rule-select{
            bottom: 6px;
        }
        .field-rule-radio{
            bottom: 16px;
        }
        .field-rule-checkbox{
            bottom: 16px;
        }
        .remark-rule{
            width: calc(100% - 1rem);
            /* position: absolute; */
            position: relative;
            left: 0;
            top: 2px;
            height: 1.6rem;
            margin: 0 0.5rem;
            font-size: 0.75rem;
            line-height: 1.6rem;
            color: #ff0000;
            text-indent: 2rem;
        }
        .field-icon{
            display: block;
            float: left;
            height: 1rem;
            margin: 0.6rem 0;
            padding-right:0.6rem;
            border-left: 0.2rem solid #635CEA;
        }
        .field-name{
            width: calc(100% - 1rem);
            display: block;
            float: left;
            margin: 0.6rem 0;
            line-height: 1.2rem;
            font-size: 16px;
            font-family:'PingFang SC';
            font-weight:500;
            color:rgba(51,51,51,1)
        }
        .field-area{
            text-align: right;
            font-size: 1rem;
            font-family:'PingFang SC';
            font-weight:400;
            color:rgba(181,181,181,1);
            padding: 0.3rem;
            cursor: pointer;
            color: #007AFF;
        }
        .field-text{
            display:inline-block;
            width: 100%;
            font-size:16px;
            font-family:'PingFang SC';
            font-weight:400;
            color:rgba(51,51,51,1);
            line-height:16px;
            height: 36px;
            padding: 6px 5px;
            line-height: 1.42857143;
            background-color: #fff;
            background-image: none;
            border: none;
            border-bottom: 1px solid #ccc;
            box-sizing: border-box;
            -webkit-box-sizing: border-box;
            outline: none;
            -webkit-appearance: none;
            border-radius: 0;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        .field-remark{
            display:inline-block;
            width: calc(100% - 40px);
            font-size:14px;
            font-family:'PingFang SC';
            font-weight:400;
            color:rgba(51,51,51,1);
            line-height:14px;
            height: 30px;
            padding: 6px 5px;
            line-height: 1.42857143;
            background-color: #fff;
            background-image: none;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            box-sizing: border-box;
            -webkit-box-sizing: border-box;
            outline: none;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        .field-text-date{
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding-left: 40px;
            background-image: url('img/icon_day.png');
            background-size: 16px 20px;
            background-position: 10px 6px;
            background-repeat: no-repeat;
        }
        .field-text-address{
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding-left: 40px;
            background-image: url('img/icon_address.png');
            background-size: 16px 20px;
            background-position: 10px 6px;
            background-repeat: no-repeat;
        }
        .field-text-select{
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding-left: 20px;
            background-image: url('img/down.png');
            background-size: 16px 20px;
            background-position: 96% 7px;
            background-repeat: no-repeat;
        }
        .field-text-number{
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .field-txt{
            width: calc(100% - 20px);
            /* height: 6rem; */
            outline: none;
            border-radius: 0.4rem;
            resize: none;
            padding: 10px;
            border-color: #e0e0e0;
            -webkit-appearance: none;
            font-size:16px;
            font-family:'PingFang SC';
            /* font-weight:bold; */
            color:rgba(0,0,0,1);
            line-height:24px;
        }
        .field-txt::-webkit-scrollbar{
            width: 6px;
            background-color: #f0f0f0;
        }
        .field-txt::-webkit-scrollbar-thumb{
            -webkit-box-shadow:inset 0 0 6px #aaa;
            border-radius: 3px;
            background-color: #aaa;
        }
        .field-div{
            padding: 0.8rem 0.4rem  0rem;
            /* height: 50px; */
            /* line-height: 50px; */
            /* border: 0px solid transparent; */
        }
        .field-div-select{
            padding-bottom: 0rem;
        }
        .field-div-option{
            padding: 1rem 0;
        }
        .field-div-radio{
            margin-bottom: 1.2rem;
        }
        .field-div-checkbox{
            margin-bottom: 1.2rem;
        }
        .field-div-remark{
            display: none;
        }
        .field-radio{
            position: absolute;
            clip: rect(0, 0, 0, 0);
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            background-color: transparent;
        }
        .field-radio + label::before {
            content: " ";
            display: inline-block;
            vertical-align: middle;;
            font-size: 16px;
            width: 18px;
            height: 18px;
            margin-right: .4em;
            border-radius: 50%;
            background: url('img/checkNo.png');
            background-size:18px 18px;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            background-color: transparent;
        }

        .field-radio:checked + label::before {
            content: " "; 
            display: inline-block;
            vertical-align: middle;
            /* font-size: 18px; */
            width: 18px;
            height: 18px;
            margin-right: .4em;
            border-radius: 50%;
            background: url('img/checkYes.png') center center no-repeat;;
            background-size:18px 18px;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            background-color: transparent;
        }
        .field-checkbox{
            position: absolute;
            clip: rect(0, 0, 0, 0);
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            background-color: transparent;
        }
        .field-checkbox + label::before {
            content: " ";
            display: inline-block;
            vertical-align: middle;
            width: 18px;
            height: 18px;
            margin-right: .4em;
            background: url('img/checkboxNo.png');
            background-size:18px 18px;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            background-color: transparent;
        }

        .field-checkbox:checked + label::before {
            content: " "; 
            display: inline-block;
            vertical-align: middle;
            width: 18px;
            height: 18px;
            margin-right: .4em;
            background: url('img/checkboxYes.png') center center no-repeat;;
            background-size:18px 18px;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            background-color: transparent;
        }
        input:-webkit-autofill {-webkit-box-shadow:0 0 0px 100px white inset;}
        input::-webkit-input-placeholder{
            color:#e0e0e0;
            font-size: 0.8rem;
            text-indent: 0rem;
            font-weight: normal;
        }
        input::-moz-placeholder{   /* Mozilla Firefox 19+ */
            color:#e0e0e0;
            font-size: 0.8rem;
            text-indent: 0rem;
            font-weight: normal;
        }
        input:-moz-placeholder{    /* Mozilla Firefox 4 to 18 */
            color:#e0e0e0;
            font-size: 0.8rem;
            text-indent: 0rem;
            font-weight: normal;
        }
        input:-ms-input-placeholder{  /* Internet Explorer 10-11 */ 
            color:#e0e0e0;
            font-size: 0.8rem;
            text-indent: 0rem;
            font-weight: normal;
        }
        textarea::-webkit-input-placeholder{
            color:#e0e0e0;
            font-size: 0.8rem;
            text-indent: 0rem;
            font-weight: normal;
        }
        footer{
            padding: 2rem 0;
            background: #f6f6f6;
        }
        .submitBtn{
            width:90%;
            margin:0 5%;
            height: 2.4rem;
            border-radius: 0.4rem;
            background: #007AFF;
            text-align: center;
            line-height: 2.4rem;
            color: #fff;
        }
        .field-file{
            width: 60px;
            height: 50px;
            padding: 0;
            margin: 0;
            background-color: #fff !important;
            border: none;
            background-image: url('img/upload.png');
            background-size:50px 50px;
            background-position:0 0;
            background-repeat: no-repeat;
            font-size: 12px;
            color:hsl(0, 0%, 100%)
        }
        .field-file>input[type="button"]{
            display: none
        }
        input[type="file" i]::-webkit-file-upload-button {
            display: none;
            width: 0;
            height: 0;
            position: relative;
            z-index:-1000;
            opacity: 0;
            filter:alpha(opacity=0);
        }

        .deleteFile{
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            position: absolute;
            top: 3px;
            left: 45px;
            background-image: url('img/deleteFile.png');
            background-size:20px 20px;
            background-position:0 0;
            background-repeat: no-repeat;
            display: none;
        }
        .orderNum{
            color: #007AFF;
        }
        .beizhu{
            font-size: 0.8rem;
            color: #888;
        }
        .remarkRed{
            border-color: #ff0000;
            box-shadow: 0px 0px 6px #e74040;;
        }
        .isRequired{
            color: #ff0000;
        }
        .field-div-file{
            position: relative;
        }
        .empty{
            width: 100%;
            height: 1rem;
            background: #f6f6f6;
            margin: 1rem 0;
        }
        .empty:last-child{
            background: #fff;
        }
        .field-file-word{
            display: inline-block;
            vertical-align: top;
            margin-top: 14px;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- <header><img src='img/img_bg.png' alt=""/></header> -->
        <form id="form" onsubmit="return false" action="#" method="post">
            
        </form>
        <footer>
            <div class="submitBtn" onclick="submit()">完成并提交</div>
        </footer>
    </div>
</body>
<script type="text/javascript" src="js/rolldate.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/zepto.js"></script>
<script type="text/javascript" src="js/data.js"></script>
<script type="text/javascript" src="js/weui.js"></script>
<script type="text/javascript" src='js/moment.js'></script>
<script>
        var params = {};

        // var IP = 'http://10.128.151.13:443';
        // // var IP = 'https://test.cictsj.com:30000'
        // var search = '?formId=1266632834734043136&userId=10008'
        // search.replace(/([^?&=]+)=([^&]+)/g, function(_, k, v){params[k] = v})

        var IP = location.origin;
        location.search.replace(/([^?&=]+)=([^&]+)/g, function(_, k, v){params[k] = v})

        var formId = params.formId;
        var userId = params.userId;
        
        
        var url = IP + "/services/web/config/questionnaireForm/getDetailByFormIdFromCache/" + formId + "/" + userId;
        var formData = {};//总表单数据
        var topicAllList = [];//总题目列表
        var FormObject = {};//提交表单数据
        var topicList1 = [];//下拉框
        var topicList2 = [];//单选框
        var topicList3 = [];//多选框
        var topicList4 = [];//数字
        var topicList5 = [];//问答
        var topicList6 = [];//城市
        var topicList7 = [];//日期
        var topicList8 = [];//附件
        var lastJoinAnswer = [];//上次填写的答案
        
        function getFormData(){
            var DataLoading = weui.loading('数据请求中...');
            $.ajax({
                type: 'get',
                url: url,
                contentType: 'application/json;charset=utf-8',
                dataType: 'json',
                success: function success(data) {
                    if(data.status === 1){
                        DataLoading.hide();
                        formData = data.root.object;
                        topicAllList = formData.form.topics;
                        console.log(formData)
                        lastJoinAnswer = formData.lastJoinAnswer||[];
                        getTopicList(topicAllList)
                        setLastAnswer(lastJoinAnswer)
                        $('#app').show()
                    }else if(data.status === 0){
                        window.location.href = IP + "/services/app/static/cicth5/form/finished.html?formId=" + params.formId + "&userId=" + params.userId + "&ToAPP=1";
                    }else{
                        DataLoading.hide();
                        var otherloading = weui.loading("系统异常");
                        setTimeout(function(){
                            otherloading.hide();
                        },3500)
                    }
                },
                error: function error(_error) {
                    
                    DataLoading.hide();
                }
            });

        }


        getFormData()
                    //题目设置
        function setNum(num) {
            if (num > 9) {
                return "<span class=\"orderNum\">" + num + "</span>";
            } else {
                return "<span class=\"orderNum\">0" + num + "</span>";
            }
        }





    // 下拉框
    function fieldItem1(item){
        // return data.map(function(item){
        //     return `<div class="form-item form-item-${item.isShow?'show':'hide'} form-item-${item.id}" data-type="${item.type}" data-count="${item.isShow?'1':'0'}">
        //                 <div class="field-name">${setNum(item.orderNum)}.${item.name}</div>
        //                 <div class="field-rule field-rule-select">${item.isRequiredQuestions?'必做题':''}</div>
        //                 <div class="field-div field-div-select">
        //                     <input name='select-${item.id}' id="select-${item.id}" data-id="${item.id}" readonly="readonly" unselectable="on" class="field-text field-text-select" placeholder="请选择"/>
        //                 </div>
                        
        //                 <div class="field-div field-div-remark field-remark-${item.id}">
        //                     <span class="beizhu">备注：</span><input name='remark-${item.id}-1' id="remark-${item.id}" data-id="${item.id}" class="field-remark field-text-remark"/>
        //                 </div>
        //             </div>`
            return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + " form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><div class=\"field-name\">" + setNum(item.orderNum) + "." + item.name + "</div><div class=\"field-rule field-rule-select\">" + (item.isRequiredQuestions ? '必做题' : '') + "</div><div class=\"field-div field-div-select\"><input type=\"text\" name=\'select-" + item.id + "\' id=\"select-" + item.id + "\" data-id=\"" + item.id + "\" readonly=\"readonly\" unselectable=\"on\" class=\"field-text field-text-select\" placeholder=\"\u8BF7\u9009\u62E9\"/></div><div class=\"field-div field-div-remark field-remark-" + item.id + "\"><span class=\"beizhu\">\u5907\u6CE8\uFF1A</span><input name=\"remark-" + item.id + "-1\" id=\"remark-" + item.id + "\" data-id=\"" + item.id + "\" class=\"field-remark field-text-remark\"/></div></div>";
        // })
    }

    //单选框
    function fieldItem2(data){
        return data.map(function(item){
            var optionList = item.content;
            var option = optionItem2(item,optionList).join('')
            return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><div class=\"field-name field-div-radio\">" + setNum(item.orderNum) + "." + item.name + "</div><div class=\"field-rule field-rule-radio\">" + (item.isRequiredQuestions ? '必做题' : '') + "</div>" + option + "<div class=\"field-div field-div-remark field-remark-" + item.id + "\"><span class=\"beizhu\">\u5907\u6CE8\uFF1A</span><input name='remark-" + item.id + "-1' id=\"remark-" + item.id + "\" data-id=\"" + item.id + "\" class=\"field-remark field-text-remark\"/></div></div>";
        })
        
    }
    function optionItem2(item,data){
        return data.map(function(e){
                return "<div class=\"field-div field-div-option\"><input type=\"radio\" data-logic='" + JSON.stringify(e.logic) + "' data-rule='" + JSON.stringify(e) + "' data-text='" + e.content + "' data-id='" + item.id + "' id=\"radio-" + item.id + "-" + e.order + "\" name=\"radio-" + item.id + "\" class=\"field-radio\" value=\"" + e.order + "\"/><label for=\"radio-" + item.id + "-" + e.order + "\">" + e.content + "</label></div>";
                })
    }

    //多选框
    function fieldItem3(data){
        return data.map(function(item){
            var optionList = item.content;
            var option = optionItem3(item,optionList).join('')
            // return `<div class="form-item form-item-${item.isShow?'show':'hide'}  form-item-${item.id}" data-type="${item.type}" data-count="${item.isShow?'1':'0'}">
            //             <div class="field-name field-div-checkbox">${setNum(item.orderNum)}.${item.name}</div>
            //             <div class="field-rule field-rule-checkbox">${item.isRequiredQuestions?'必做题':''}</div>
            //             ${option}
            //         </div>`
            return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><div class=\"field-name field-div-checkbox\">" + setNum(item.orderNum) + "." + item.name + "</div><div class=\"field-rule field-rule-checkbox\">" + (item.isRequiredQuestions ? '必做题' : '') + "</div>" + option + "</div>";
        })
        
    }
    function optionItem3(item,data){
        var rule = JSON.parse(item.typeDetailLimit)
        rule.isRequiredQuestions = item.isRequiredQuestions;
        var ruleStr = JSON.stringify(rule)
        return data.map(function(e){
                return "<div class=\"field-div field-div-option\"><input type=\"checkbox\" data-rule='" + ruleStr + "' data-rule2='" + JSON.stringify(e) + "' data-content='" + e.content + "' data-id=\"" + item.id + "\" data-logic='" + JSON.stringify(e.logic) + "'' id=\"checkbox-" + item.id + "-" + e.order + "\" name=\"checkbox-" + item.id + "\" class=\"field-checkbox\" value=\"" + e.order + "\"><label for=\"checkbox-" + item.id + "-" + e.order + "\" class=\"checkbox-" + item.id + "-" + e.order + "\">" + e.content + "</label><div class=\"field-div field-div-remark field-remark-" + item.id + "-" + e.order + "\"><span class=\"beizhu\">\u5907\u6CE8\uFF1A</span><input name='remark-" + item.id + "-" + e.order + "' data-order='" + e.order + "' data-rule='" + JSON.stringify(e) + "' id=\"remark-" + item.id + "-" + e.order + "\" data-id=\"" + item.id + "\"  class=\"field-remark field-text-remark\"/></div></div>";
                })
    }

        //多选框
        function fieldItem3(item){
                var optionList = item.content;
                var option = optionItem3(item,optionList)
                return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><div class=\"field-name field-div-checkbox\">" + setNum(item.orderNum) + "." + item.name + "</div><div class=\"field-rule field-rule-checkbox\">" + (item.isRequiredQuestions ? '必做题' : '') + "</div>" + option + "</div>";
        }
        function optionItem3(item,data){
            var rule = eval("("+item.typeDetailLimit+")")
            console.log(item,data)
            rule.isRequiredQuestions = item.isRequiredQuestions;
            var ruleStr = JSON.stringify(rule)
            var optionStr = "";
            data.map(function(e){
                    optionStr = optionStr +  "<div class=\"field-div field-div-option\"><input type=\"checkbox\" data-rule=\'" + ruleStr + "\' data-rule2=\'" + JSON.stringify(e) + "\' data-content=\'" + e.content + "\' data-id=\"" + item.id + "\" data-logic=\'" + JSON.stringify(e.logic) + "\' id=\"checkbox-" + item.id + "-" + e.order + "\" name=\"checkbox-" + item.id + "\" class=\"field-checkbox\" value=\"" + e.order + "\"><label for=\"checkbox-" + item.id + "-" + e.order + "\" class=\"checkbox-" + item.id + "-" + e.order + "\">" + e.content + "</label><div class=\"field-div field-div-remark field-remark-" + item.id + "-" + e.order + "\"><span class=\"beizhu\">\u5907\u6CE8\uFF1A</span><input name=\'remark-" + item.id + "-" + e.order + "\' data-order=\'" + e.order + "\' data-rule=\'" + JSON.stringify(e) + "\' id=\"remark-" + item.id + "-" + e.order + "\" data-id=\"" + item.id + "\"  class=\"field-remark field-text-remark\"/></div></div>";
                    })
            return optionStr
        }
        //数字类型
        function fieldItem4(item){
            var rule = JSON.parse(item.typeDetailLimit)
            rule.isRequiredQuestions = item.isRequiredQuestions;
            var ruleStr = JSON.stringify(rule)
            return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><span class=\"field-name\">" + setNum(item.orderNum) + "." + item.name + "</span><div class=\"field-rule\">" + (item.isRequiredQuestions ? '必做题' : '') + "</div><div class=\"field-div\"><input type=\"text\" name='number-" + item.id + "' id=\'number-" + item.id + "\' data-rule=\'" + ruleStr + "\' class=\"field-text field-text-number\" placeholder=\"请输入数字\"/></div></div>";
            
        }

        //问答
        function fieldItem5(item){
            var rule = eval("("+item.typeDetailLimit+")");
            rule.isRequiredQuestions = item.isRequiredQuestions;
            var ruleStr = JSON.stringify(rule)

            return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><span class=\"field-name\">" + setNum(item.orderNum) + "." + item.name + "</span><div class=\"field-rule\">" + (item.content ? '' : item.isRequiredQuestions ? '必做题' : '') + "</div><div class=\"field-div\"><textarea name=\'textarea-" + item.id + "\' id=\'textarea-" + item.id + "\' class=\"field-txt\" rows=\"6\" data-rule=\'" + ruleStr + "\' placeholder=\"\u8BF7\u586B\u5199\">" + (item.content || '') + "</textarea></div></div>";
            
        }
        //城市
        function fieldItem6(item){
            var rule = eval("("+item.typeDetailLimit+")");
            var includeAll = rule.includeAll?"<div class=\"field-area\">\u6D77\u5916\u5730\u533A\u586B\u5199></div>":''
            var height = Math.ceil(rule.max/18)
            var ruleStr = JSON.stringify(rule)
            return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><span class=\"field-name\">" + setNum(item.orderNum) + "." + item.name + "</span><div class=\"field-rule\">" + (item.content ? '' : item.isRequiredQuestions ? '必做题' : '') + "</div><div class=\"field-div\"><input type=\"text\" name=\'address-" + item.id + "\' id=\"address-" + item.id + "\" data-rule=\'" + ruleStr + "\' readonly=\"readonly\" unselectable=\"on\" class=\"field-text field-text-address\" placeholder=\"\u7701/\u5E02/\u533A/\u8BE6\u7EC6\u5730\u5740\"/>" + includeAll + "</div></div>";
        }

    //日期
    function fieldItem7(item){
        return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><span class=\"field-name\">" + setNum(item.orderNum) + "." + item.name + "</span><div class=\"field-rule\">" + (item.content ? "" : item.isRequiredQuestions ? '必做题' : '') + "</div><div class=\"field-div\"><input type=\"text\" name=\"date-" + item.id + "\" data-rule=\'" + item.typeDetailLimit + "\' id=\"date-" + item.id + "\"  placeholder=\"\u8BF7\u9009\u62E9\u65E5\u671F\" readonly=\"readonly\" unselectable=\"on\" class=\"field-text field-text-date\"/></div></div>";
        
    }

    //附件
    function fieldItem8(data){
        return data.map(function(item){
            var rule = JSON.parse(item.typeDetailLimit).type;
            var acceptType = '';
            if(rule.indexOf('jpg,jpeg,png,gif')>-1){
                acceptType = acceptType + 'image/jpeg,jpeg,image/png,image/gif'
            }
            if(rule.indexOf('word,excel,powerpoint,pdf')>-1){
                acceptType = acceptType + 'application/msword,application/vnd.ms-excel,application/vnd.ms-powerpoint,application/pdf'
            }
            if(rule.indexOf('mp3,mp4')>-1){
                acceptType = acceptType + 'audio/mp3,video/mp4'
            }
            if(rule.indexOf('zip,rar,7z')>-1){
                acceptType = acceptType + 'application/x-zip-compressed'
            }
            return "<div class=\"form-item form-item-" + (item.isShow ? 'show' : 'hide') + "  form-item-" + item.id + "\" data-type=\"" + item.type + "\" data-count=\"" + (item.isShow ? '1' : '0') + "\"><span class=\"field-name\">" + setNum(item.orderNum) + "." + item.name + "</span><div class=\"field-rule field-rule-" + item.id + "\">" + (item.isRequiredQuestions ? '必做题' : '') + "</div><div class=\"field-div field-div-file\"><input type=\"file\" title=\"\" id=\"file-" + item.id + "\" accept=\"" + acceptType + "\" data-id=\"" + item.id + "\"  name=\"file-" + item.id + "\" data-rule=\'" + item.typeDetailLimit + "\' class=\"field-text field-file\" /><div class=\"field-file-word\">点击上传附件</div><div class=\'deleteFile deleteFile-" + item.id + "\' data-rule=\"" + item.isRequiredQuestions + "\" data-id=\"" + item.id + "\"></div></div></div>";
        })
        
    }

    function getTopicList(topicAllList){
            topicAllList.map(function(item){
                if(item.type === 1){
                    // item.content = JSON.parse(item.content)
                    item.content = eval("("+item.content+")")
                    topicList1.push(item)
                    $('#form').append(fieldItem1(item))
                }else if(item.type === 2){
                    // item.content = JSON.parse(item.content)
                    item.content = eval("("+item.content+")")
                    topicList2.push(item)
                    $('#form').append(fieldItem2([item]).join(''))
                }else if(item.type === 3){
                    // item.content = JSON.parse(item.content)
                    item.content = eval("("+item.content+")")
                    topicList3.push(item)
                    $('#form').append(fieldItem3(item))
                }else if(item.type === 4){
                    topicList4.push(item)
                    $('#form').append(fieldItem4(item))
                }else if(item.type === 5){
                    topicList5.push(item)
                    $('#form').append(fieldItem5(item))
                }else if(item.type === 6){
                    topicList6.push(item)
                   
                    $('#form').append(fieldItem6(item))
                }else if(item.type === 7){
                    topicList7.push(item)
                    $('#form').append(fieldItem7(item))
                }else if(item.type === 8){
                    topicList8.push(item)
                    $('#form').append(fieldItem8([item]).join(''))
                }
                
                $('#form').append("<div class=\"empty\"></div>")
            })
            
        }

   

</script>
<script>
    function setLastAnswer(data){
        data.map(function(item){
            console.log(item)

            var topicId = item.topicId;
            var type = $(".form-item-" + topicId).attr("data-type");
            $(".form-item-" + topicId).children(".field-rule").html('');

            if(type === '1'){
                if(item.content){
                    $(".form-item-" + topicId).show();
                    FormObject["select-" + topicId] = item.content;
                    $("#select-" + topicId).val(item.content);
                }
                if(item.remark){
                    // FormObject[`remark-${topicId}_1`] = item.remark
                    // let remarkObj = JSON.parse(item.remark)
                    // $(`.field-remark-${topicId}`).show()
                    // $(`#remark-${topicId}`).val(remarkObj.desp)
                    // if(remarkObj.required){
                    //     $(`#remark-${topicId}`).attr('data-required','1')
                    // }else{
                    //     $(`#remark-${topicId}`).attr('data-required','0')
                    // }
                    FormObject["remark-" + topicId + "_1"] = item.remark;
                    var remarkObj = JSON.parse(item.remark);
                    $(".field-remark-" + topicId).show();
                    $("#remark-" + topicId).val(remarkObj.desp);

                    if (remarkObj.required) {
                        $("#remark-" + topicId).attr('data-required', '1');
                    } else {
                        $("#remark-" + topicId).attr('data-required', '0');
                    }
                    
                }
            

            }else if(type === '2'){
                if(item.content){
                    // $(`.form-item-${topicId}`).show()
                    // FormObject[`radio-${topicId}`] = item.content;
                    // let content = item.content
                    // $(`input[name=radio-${topicId}]`).each(function(order){
                    //     let text = $(`#radio-${topicId}-${order+1}`).attr('data-text')
                    //     if(content===text){
                    //         $(`#radio-${topicId}-${order+1}`).attr("checked", 'checked');
                    //     }
                        
                    // })
                    $(".form-item-" + topicId).show();
                    FormObject["radio-" + topicId] = item.content;
                    var content = item.content;
                    $("input[name=radio-" + topicId + "]").each(function (order) {
                        var text = $("#radio-" + topicId + "-" + (order + 1)).attr('data-text');

                        if (content === text) {
                            $("#radio-" + topicId + "-" + (order + 1)).attr("checked", 'checked');
                        }
                    });
                }
                if(item.remark){
                    // FormObject[`remark-${topicId}_1`] = item.remark
                    // let remarkObj = JSON.parse(item.remark)
                    // $(`.field-remark-${topicId}`).show()
                    // $(`#remark-${topicId}`).val(remarkObj.desp)
                    // if(remarkObj.required){
                    //     $(`#remark-${topicId}`).attr('data-required','1')
                    // }else{
                    //     $(`#remark-${topicId}`).attr('data-required','0')
                    // }
                    FormObject["remark-" + topicId + "_1"] = item.remark;
                    var remarkObj = JSON.parse(item.remark);
                    $(".field-remark-" + topicId).show();
                    $("#remark-" + topicId).val(remarkObj.desp);

                    if (remarkObj.required) {
                        $("#remark-" + topicId).attr('data-required', '1');
                    } else {
                        $("#remark-" + topicId).attr('data-required', '0');
                    }
                }
                

            }else if(type === '3'){
                if(item.content){
                    // $(`.form-item-${topicId}`).show()
                    // FormObject[`checkbox-${topicId}`] = item.content;
                    // let list = item.content.split(';')
                    // $(`input[name=checkbox-${topicId}]`).each(function(order){
                    //     let content = $(`#checkbox-${topicId}-${order+1}`).attr('data-content')
                    //     if(list.indexOf(content)>-1){
                    //         $(`#checkbox-${topicId}-${order+1}`).attr("checked", 'checked');
                    //     }
                    // })
                    $(".form-item-" + topicId).show();
                    FormObject["checkbox-" + topicId] = item.content;
                    var list = item.content.split(';');
                    $("input[name=checkbox-" + topicId + "]").each(function (order) {
                        var content = $("#checkbox-" + topicId + "-" + (order + 1)).attr('data-content');

                        if (list.indexOf(content) > -1) {
                            $("#checkbox-" + topicId + "-" + (order + 1)).attr("checked", 'checked');
                        }
                    });
                }
                if(item.remark){
                    var remarkList = JSON.parse(item.remark)
                    remarkList.map(function(item2){
                        // $(`.field-remark-${topicId}-${item2.order}`).show()
                        // $(`#remark-${topicId}-${item2.order}`).val(item2.desp)
                        // FormObject[`remark-${topicId}_${item2.order}`] = JSON.stringify(item2)
                        // if(item2.required){
                        //     $(`#remark-${topicId}-${item2.order}`).attr('data-required','1')
                        // }else{
                        //     $(`#remark-${topicId}-${item2.order}`).attr('data-required','0')
                        // }
                        $(".field-remark-" + topicId + "-" + item2.order).show();
                        $("#remark-" + topicId + "-" + item2.order).val(item2.desp);
                        FormObject["remark-" + topicId + "_" + item2.order] = JSON.stringify(item2);

                        if (item2.required) {
                            $("#remark-" + topicId + "-" + item2.order).attr('data-required', '1');
                        } else {
                            $("#remark-" + topicId + "-" + item2.order).attr('data-required', '0');
                        }
                    })
                    
                }
                

            }else if(type === '4'){
                if(item.content){
                    $(".form-item-" + topicId).show();
                    FormObject["number-" + topicId] = item.content;
                    $("#number-" + topicId).val(item.content);
                }
                

            }else if(type === '5'){
                if(item.content){
                    $(".form-item-" + topicId).show();
                    FormObject["textarea-" + topicId] = item.content;
                    $("#textarea-" + topicId).val(item.content);
                }
            

            }else if(type === '6'){
                if(item.content){
                    $(".form-item-" + topicId).show();
                    FormObject["address-" + topicId] = item.content;
                    $("#address-" + topicId).val(item.content);
                }
                
            }else if(type === '7'){
                if(item.content){
                    $(".form-item-" + topicId).show();
                    FormObject["date-" + topicId] = item.content;
                    $("#date-" + topicId).val(item.content);
                }
                

            }else if(type === '8'){
                if(item.content){
                    $(".form-item-" + topicId).show();
                    FormObject["file-" + topicId] = item.content;
                    $("#file-" + topicId).css('backgroundImage', 'url(img/uploadOk.png)');
                    $(".deleteFile-" + topicId).css('display', 'block');
                }
                
            }
        })
    }

</script>
<script>
    
    //下拉框
    $(document).on('click','.field-text-select',function(){
        // let that = $(this)
        // let topicId = that.attr("data-id")
        // let name = $(this).attr('name')
        // let list = topicList1.filter(item=>{return item.id===topicId})[0].content;

        var that = $(this);
        var topicId = that.attr("data-id");
        var name = $(this).attr('name');
        var list = topicList1.filter(function (item) {
            return item.id === topicId;
        })[0].content;

        list.map(function (item) {
            item.label = item.content;
            item.value = item.order;
            item.logic = item.logic || [];
        });
        weui.picker(list, 
            {
                onChange: function (e) {
                    console.log(e);
                },
                onConfirm: function (e) {

                    that.val(e[0].label)

                    $(".orderNum-" + topicId).removeClass('isRequired');
                    that.parent().parent().children(".field-rule").html('')
                    var logic = e[0].logic;
                    var order = e[0].order;
                    console.log(logic)

                    FormObject[name] = e[0].label;
                    console.log(FormObject)

                    var remark = e[0].remark;
                    var required = e[0].required;
                    // if(remark){
                    //     $(`.field-remark-${topicId}`).show()
                    //     $(`#remark-${topicId}`).val('')
                    //     FormObject[`remark-${topicId}_1`] = JSON.stringify({desp:'',required:required,logic:logic})
                    // }else{
                    //     $(`.field-remark-${topicId}`).hide();
                    //     $(`#remark-${topicId}`).val('')
                    //     FormObject[`remark-${topicId}_1`] = ''
                    // }
                    // if(required){
                    //     $(`#remark-${topicId}`).addClass('remarkRed')
                    //     $(`#remark-${topicId}`).attr('data-required','1')
                    // }else{
                    //     $(`#remark-${topicId}`).removeClass('remarkRed')
                    //     $(`#remark-${topicId}`).attr('data-required','0')
                    // }
                    if (remark) {
                        $(".field-remark-" + topicId).show();
                        $("#remark-" + topicId).val('');
                        FormObject["remark-" + topicId + "_1"] = JSON.stringify({
                            desp: '',
                            required: required,
                            logic: logic
                        });
                    } else {
                        $(".field-remark-" + topicId).hide();
                        $("#remark-" + topicId).val('');
                        FormObject["remark-" + topicId + "_1"] = '';
                    }

                    if (required) {
                        $("#remark-" + topicId).addClass('remarkRed');
                        $("#remark-" + topicId).attr('data-required', '1');
                    } else {
                        $("#remark-" + topicId).removeClass('remarkRed');
                        $("#remark-" + topicId).attr('data-required', '0');
                    }

                    // list.map(item=>{
                    //     if(item.order!==order){
                    //         let otherlogic = item.logic;
                    //         otherlogic.length&&otherlogic.map(item=>{
                    //             let el = $(`.form-item-${item}`).attr('data-count') - 1;
                    //             el = el<0?0:el
                    //             $(`.form-item-${item}`).attr('data-count',el)
                    //             el===0&&$(`.form-item-${item}`).addClass('form-item-hide')
                    //             topicAllList.map(e=>{
                    //                 if(e.id===item){
                    //                     e.isShow = false;
                    //                 }
                    //             })
                    //         })
                    //     }
                    // })
                    list.map(function (item) {
                        if (item.order !== order) {
                            var otherlogic = item.logic;
                            otherlogic.length && otherlogic.map(function (item2) {
                                var el = $(".form-item-" + item2).attr('data-count') - 1;
                                el = el < 0 ? 0 : el;
                                $(".form-item-" + item2).attr('data-count', el);
                                el === 0 && $(".form-item-" + item2).addClass('form-item-hide');
                                topicAllList.map(function (e) {
                                    if (e.id === item2) {
                                    e.isShow = false;
                                    }
                                });
                            });
                        }
                    });

                    // logic.length&&logic.map(item=>{
                    //     let el = $(`.form-item-${item}`).attr('data-count')*1 + 1;
                    //     $(`.form-item-${item}`).attr('data-count',el).removeClass('form-item-hide')
                    //     topicAllList.map(e=>{
                    //         if(e.id===item){
                    //             e.isShow = true;
                    //         }
                    //     })
                    // })
                    logic.length && logic.map(function (item) {
                        var el = $(".form-item-" + item).attr('data-count') * 1 + 1;
                        $(".form-item-" + item).attr('data-count', el).removeClass('form-item-hide');
                        topicAllList.map(function (e) {
                            if (e.id === item) {
                            e.isShow = true;
                            }
                        });
                    });
                    
                }
        });
    })

    //单选框
    $(document).on('click','.field-radio',function(){
        $(this).attr('data-check','1')

        var that = $(this)

        var value = $(this).val()

        var topicId = $(this).attr('data-id');

        var name = $(this).attr('name');

        var content = $(this).attr('data-text')

        var rule = JSON.parse(that.attr('data-rule'))

        var remark = rule.remark;
        var required = rule.required;
        // if(remark){
        //     $(`.field-remark-${topicId}`).show()
        //     $(`#remark-${topicId}`).val('')
        //     FormObject[`remark-${topicId}_1`] = JSON.stringify({desp:'',required:required,logic:rule.logic})
        // }else{
        //     $(`.field-remark-${topicId}`).hide();
        //     $(`#remark-${topicId}`).val('')
        //     FormObject[`remark-${topicId}_1`] = ''
        // }
        // if(required){
        //     $(`#remark-${topicId}`).addClass('remarkRed')
        //     $(`#remark-${topicId}`).attr('data-required','1')
        // }else{
        //     $(`#remark-${topicId}`).removeClass('remarkRed')
        //     $(`#remark-${topicId}`).attr('data-required','0')
        // }
        if (remark) {
            $(".field-remark-" + topicId).show();
            $("#remark-" + topicId).val('');
            FormObject["remark-" + topicId + "_1"] = JSON.stringify({
                desp: '',
                required: required,
                logic: rule.logic
            });
        } else {
            $(".field-remark-" + topicId).hide();
            $("#remark-" + topicId).val('');
            FormObject["remark-" + topicId + "_1"] = '';
        }

        if (required) {
            $("#remark-" + topicId).addClass('remarkRed');
            $("#remark-" + topicId).attr('data-required', '1');
        } else {
            $("#remark-" + topicId).removeClass('remarkRed');
            $("#remark-" + topicId).attr('data-required', '0');
        }

        FormObject[name] = content;
        var radioList = $("input:radio[name=\"" + name + "\"]").not(this)

        radioList.each(function() { 
            if($(this).attr('data-check')==='1'){
                var otherlogic = $(this).attr('data-logic');
                otherlogic = JSON.parse(otherlogic);
                // otherlogic.length&&otherlogic.map(item=>{
                //     let el = $(`.form-item-${item}`).attr('data-count') - 1;
                //     el = el<0?0:el;
                //     el===0&&$(`.form-item-${item}`).addClass('form-item-hide').attr('data-count','0')
                //     $(`.form-item-${item}`).attr('data-count',el)
                //     topicAllList.map(e=>{
                //         if(e.id===item){
                //             e.isShow = false;
                //         }
                //     })
                    
                // })
                otherlogic.length && otherlogic.map(function (item) {
                    var el = $(".form-item-" + item).attr('data-count') - 1;
                    el = el < 0 ? 0 : el;
                    el === 0 && $(".form-item-" + item).addClass('form-item-hide').attr('data-count', '0');
                    $(".form-item-" + item).attr('data-count', el);
                    topicAllList.map(function (e) {
                        if (e.id === item) {
                        e.isShow = false;
                        }
                    });
                });
            }
            $(this).attr('data-check','0');
        });

        var logic = $(this).attr('data-logic');
        logic = JSON.parse(logic)

        // logic.length&&logic.map(item=>{
        //     let el = $(`.form-item-${item}`).attr('data-count')*1 + 1;
        //     $(`.form-item-${item}`).attr('data-count',el).removeClass('form-item-hide')
        //     topicAllList.map(e=>{
        //         if(e.id===item){
        //             e.isShow = true;
        //         }
        //     })
        // })
        logic.length && logic.map(function (item) {
            var el = $(".form-item-" + item).attr('data-count') * 1 + 1;
            $(".form-item-" + item).attr('data-count', el).removeClass('form-item-hide');
            topicAllList.map(function (e) {
                if (e.id === item) {
                e.isShow = true;
                }
            });
        });
        $(".orderNum-" + topicId).removeClass('isRequired');
        $(this).parent().parent().children(".field-rule").html('')
        
    })

    //多选框
    $(document).on('click','.field-checkbox',function(){
        var that = $(this)

        var value = $(this).val()

        var name = $(this).attr('name')

        var topicId = $(this).attr('data-id')

        var rule = JSON.parse(that.attr("data-rule"));

        var rule2 = JSON.parse(that.attr("data-rule2"));


        var logic = $(this).attr('data-logic');
        logic = JSON.parse(logic)


        var remark = rule2.remark;
        var required = rule2.required;
 

        var list=[];
        var isCheck = $(this).prop('checked');
        if(isCheck){

            // if(remark){
            //     $(`.field-remark-${topicId}-${rule2.order}`).show()
            //     $(`#remark-${topicId}-${rule2.order}`).val('')
            //     FormObject[`remark-${topicId}_${rule2.order}`] = JSON.stringify({order:rule2.order,desp:'',required:required,logic:logic})
            // }

            // if(required){
            //     $(`#remark-${topicId}-${rule2.order}`).addClass('remarkRed')
            //     $(`#remark-${topicId}-${rule2.order}`).attr('data-required','1')
            // }
            if (remark) {
                $(".field-remark-" + topicId + "-" + rule2.order).show();
                $("#remark-" + topicId + "-" + rule2.order).val('');
                FormObject["remark-" + topicId + "_" + rule2.order] = JSON.stringify({
                    order: rule2.order,
                    desp: '',
                    required: required,
                    logic: logic
                });
            }

            if (required) {
                $("#remark-" + topicId + "-" + rule2.order).addClass('remarkRed');
                $("#remark-" + topicId + "-" + rule2.order).attr('data-required', '1');
            }

            // logic.length&&logic.map(item=>{
            //     let el = $(`.form-item-${item}`).attr('data-count')*1 + 1;
            //     $(`.form-item-${item}`).attr('data-count',el).removeClass('form-item-hide')
            //     topicAllList.map(e=>{
            //         if(e.id===item){
            //             e.isShow = true;
            //         }
            //     })
            // })
            logic.length && logic.map(function (item) {
                var el = $(".form-item-" + item).attr('data-count') * 1 + 1;
                $(".form-item-" + item).attr('data-count', el).removeClass('form-item-hide');
                topicAllList.map(function (e) {
                    if (e.id === item) {
                    e.isShow = true;
                    }
                });
            });
        }else{

            // $(`.field-remark-${topicId}-${rule2.order}`).hide();
            // $(`#remark-${topicId}-${rule2.order}`).val('')
            // delete FormObject[`remark-${topicId}_${rule2.order}`]

            // $(`#remark-${topicId}-${rule2.order}`).removeClass('remarkRed')
            // $(`#remark-${topicId}-${rule2.order}`).attr('data-required','0')

            $(".field-remark-" + topicId + "-" + rule2.order).hide();
            $("#remark-" + topicId + "-" + rule2.order).val('');
            delete FormObject["remark-" + topicId + "_" + rule2.order];
            $("#remark-" + topicId + "-" + rule2.order).removeClass('remarkRed');
            $("#remark-" + topicId + "-" + rule2.order).attr('data-required', '0');



            // logic.length&&logic.map(item=>{
            //     let el = $(`.form-item-${item}`).attr('data-count')*1 - 1;
            //     el = el<0?0:el
            //     if(el === 0 ){
            //         $(`.form-item-${item}`).addClass('form-item-hide')
            //         topicAllList.map(e=>{
            //             if(e.id===item){
            //                 e.isShow = false;
            //             }
            //         })
            //     }
            //     $(`.form-item-${item}`).attr('data-count',el)
                
            // })
            logic.length && logic.map(function (item) {
                var el = $(".form-item-" + item).attr('data-count') * 1 - 1;
                el = el < 0 ? 0 : el;

                if (el === 0) {
                    $(".form-item-" + item).addClass('form-item-hide');
                    topicAllList.map(function (e) {
                        if (e.id === item) {
                            e.isShow = false;
                        }
                    });
                }

                $(".form-item-" + item).attr('data-count', el);
            });
        }

        $("input[name='" + name + "']:checked").each(function() { 
            list.push($(this).next().text());
        });

        FormObject[name] = list.join(';')
        if(list.length){
            if(list.length<rule.min){
                $(this).parent().parent().children(".field-rule").html("最少选择"+rule.min+"项")
            }else if(list.length>rule.max){
                $(this).parent().parent().children(".field-rule").html("最多选择"+rule.max+"项")
            }else{
                $(this).parent().parent().children(".field-rule").html('')
            }
            $(".orderNum-" + topicId).removeClass('isRequired')
           
        }else{
            if(rule.isRequiredQuestions){
                $(".orderNum-" + topicId).addClass('isRequired')
                $(this).parent().parent().children(".field-rule").html('必做题')
            }else{
                $(this).parent().parent().children(".field-rule").html('')
            }
            
        }
        
        
    })

    //数字
    $(document).on('input','.field-text-number',function(){
        var that = $(this);
        var value = that.val();
        var rule = JSON.parse(that.attr("data-rule"));
        console.log('数字',rule)
        if(value===""){
            if(rule.isRequiredQuestions){
                $(this).parent().parent().children(".field-rule").html('必做题');
            }else{
                $(this).parent().parent().children(".field-rule").html('');
            }
            
        }else if(isNaN(value)){
            $(this).parent().parent().children(".field-rule").html('非数字值，请规范填写')
        }else{
            var num = Number(value)
            var numReg = /[0-9]{1,1000}.[0-9]{4,1000}$/;
            if(!isNaN(rule.min)){
                if(num<rule.min){
                    $(this).parent().parent().children(".field-rule").html("数值范围为"+rule.min+"~"+rule.max)
                }else if(num>rule.max){
                    $(this).parent().parent().children(".field-rule").html("数值范围为"+rule.min+"~"+rule.max)
                }else if(rule.numbersetup.indexOf('2')<0&&String(value).indexOf('.')>-1){
                    $(this).parent().parent().children(".field-rule").html("限制小数输入")
                }else if(rule.numbersetup.indexOf('3')<0&&num<0){
                    $(this).parent().parent().children(".field-rule").html("限制负数输入")
                }else{
                    $(this).parent().parent().children(".field-rule").html('')
                }
                // else if(value.indexOf('.')>-1&&value.match(numReg)){
                //     $(this).parent().parent().children(".field-rule").html("保留三位小数点")
                // }
            }else{
                if(rule.numbersetup.indexOf('2')<0&&String(value).indexOf('.')>-1){
                    $(this).parent().parent().children(".field-rule").html("限制小数输入")
                }else if(rule.numbersetup.indexOf('3')<0&&num<0){
                    $(this).parent().parent().children(".field-rule").html("限制负数输入")
                }else{
                    $(this).parent().parent().children(".field-rule").html('')
                }
                
                // else if(value.indexOf('.')>-1&&value.match(numReg)){
                //     $(this).parent().parent().children(".field-rule").html("保留三位小数点")
                // }
            }
        }
    })

    //问答
    $(document).on('input','.field-txt',function(){
        var that = $(this);
        var value = that.val();
        var rule = that.attr("data-rule");
        rule = JSON.parse(rule)
        if(value.length>rule.max){
            $(this).parent().parent().children(".field-rule").html("字数限制"+rule.max+"字")
        }else{
            if(rule.isRequiredQuestions&&value===""){
                $(this).parent().parent().children(".field-rule").html('必做题')
            }else{
                $(this).parent().parent().children(".field-rule").html('')
            }
        }
    })
    
    //城市
    $(document).on('click','.field-text-address',function(){
        var that = $(this)
        var value = $(this).val()
        var list = [];
        var rule = that.attr("data-rule");
        
        rule = JSON.parse(rule)
        console.log(rule)
        var min = 3 - rule.min;
        var provinceLimit = rule.provinceLimit;
        if(provinceLimit == '100000'){
            list = chinaCityList
        }else{
            list = chinaCityList.filter(function(item){
                return item.value == provinceLimit
            })
        }
        
        console.log(list)
        weui.picker(list, 
            {
                // defaultValue: ['110000','110100','110101'],
                depth:min,
                onChange: function (e) {
                    console.log(e);
                },
                onConfirm: function (e) {
                    console.log(e);  
                    if(min===1){
                        that.val(e[0].label)
                    }else if(min===2){
                        if(e.length===1){
                            that.val(e[0].label)
                        }else if(e.length===2){
                            that.val(e[0].label + "|" + e[1].label);
                        }else if(e.length===3){
                            that.val(e[0].label + "|" + e[1].label);
                        }
                    }else if(min===3){
                        if(e.length===1){
                            that.val(e[0].label)
                        }else if(e.length===2){
                            that.val(e[0].label + "|" + e[1].label);
                        }else if(e.length===3){
                            that.val(e[0].label + "|" + e[1].label + "|" + e[2].label);
                        }
                    }
  
                    that.parent().parent().children(".field-rule").html('')      
                }
            }
        );
       
        
    })

    //海外国家
    $(document).on('click','.field-area',function(){
        var that = $(this)
        // let value = $(this).val()
        weui.picker(country, 
            {
                defaultValue: ['1'],
                onChange: function (e) {
                    console.log(e);
                },
                onConfirm: function (e) {
                    that.prev().val(e[0].label)
                    that.parent().parent().children(".field-rule").html('')   
                }
            }
        );
    })

    //日期
    $(document).on('click','.field-text-date',function(){
        var that = $(this);
        var id = $(this).attr('id');
        var datarule = $(this).attr('data-rule')
        console.log(datarule)
        var rule = eval("("+datarule+")")
        var format = rule.format.toUpperCase();
        if(format==='YYYY-MM-DD'||format==='YYYY-MM'||format==='YYYY'||format==='MM-DD'||format==='DD'){
            weui.datePicker({
                start:2000,
                end:2099,
                // end: new Date(),
                defaultValue: [new Date().getFullYear(), new Date().getMonth()+1, new Date().getDate()],
                depth:format==='YYYY-MM-DD'?3:format==='YYYY-MM'?2:format==='YYYY'?1:3,
                onChange: function (e) {
                    console.log(e);
                    
                },
                onConfirm: function (e) {
                    console.log(e);
                    if(format==='YYYY-MM-DD'){
                        that.val(e[0].value + "-" + e[1].value + "-" + e[2].value);
                        if(rule.min){
                            var min = new Date(rule.min.replace(/-/g,'/')).getTime();
                            if(Number(rule.delay)>0){
                                var newDate = moment(new Date()).format('YYYY/MM/DD')
                                min = new Date(newDate).getTime() + rule.delay*3600*24*1000;
                            }
                            var max = new Date(rule.max.replace(/-/g,'/')).getTime();
                           
                            var time = new Date(e[0].value + "/" + (e[1].value * 1 < 10 ? '0' + e[1].value : e[1].value) + "/" + e[2].value).getTime();
                            if(time<min||time>max){
                                that.parent().parent().children(".field-rule").html("时间限制范围"+moment(min).format('YYYY-MM-DD')+"~"+rule.max)
                            }else{
                                that.parent().parent().children(".field-rule").html('')
                            }
                            
                        }else{
                            that.parent().parent().children(".field-rule").html('')
                        }
                    }else if(format==='YYYY-MM'){
                        that.val(e[0].value+"-"+e[1].value)
                        if(rule.min){
                            var min = new Date(moment(rule.min).format('YYYY/MM/01')).getTime();
                            var max = new Date(rule.max.replace(/-/g,'/')).getTime();
                            var nowTime = new Date(moment(e[0].value + "-" + (e[1].value * 1 < 10 ? '0' + e[1].value : e[1].value) + "-01").format('YYYY/MM/DD')).getTime();
                            if(nowTime<min||nowTime>max){
                                that.parent().parent().children(".field-rule").html("时间限制范围"+moment(rule.min).format('YYYY-MM')+"~"+moment(rule.max).format('YYYY-MM'))
                            }else{
                                that.parent().parent().children(".field-rule").html('')
                            }
                        }else{
                            that.parent().parent().children(".field-rule").html('')
                        }
                    }else if(format==='MM-DD'){
                        that.val(e[1].value + "-" + e[2].value);
                        that.parent().parent().children(".field-rule").html('')
                    }else if(format==='YYYY'){
                        that.val(e[0].value)
                        if(rule.min){
                            var min = Number(rule.min.substring(0,4));
                            var max = Number(rule.max.substring(0,4));
                            var nowTime = Number(e[0].value);
                            if(nowTime<min||nowTime>max){
                                that.parent().parent().children(".field-rule").html("时间限制范围"+min+"~"+max)
                            }else{
                                that.parent().parent().children(".field-rule").html('')
                            }
                        }else{
                            that.parent().parent().children(".field-rule").html('')
                        }
                    }else if(format==='MM'){
                        that.val(e[1].value)
                        that.parent().parent().children(".field-rule").html('')
                    }else if(format==='DD'){
                        that.val(e[2].value)
                        that.parent().parent().children(".field-rule").html('')
                        console.log('日')
                    }
                }
            });
            if(format==='MM-DD'){
                $(".weui-picker__group").eq(0).remove()
            }else if(format==='DD'){
                $(".weui-picker__group").eq(0).hide()
                $(".weui-picker__group").eq(1).hide()
            }
        }else if(format==='MM'){
            var list = []
            for(var i=1;i<13;i++){
                list.push({label:i+'月',value:i})
            }
            weui.picker(list, 
                {
                    onChange: function (e) {
                        console.log(e);
                    },
                    onConfirm: function (e) {
                        console.log(e);
                        that.val(e[0].value)
                        that.parent().parent().children(".field-rule").html('')
                        console.log('月')
                    }
            });
        }
    })

    //附件
    $(document).on('change','.field-file',function(){
        var that = this;
        var fileObj = $(this)[0].files[0];
        console.log(fileObj,fileObj.type)

        var rule = $(this).attr("data-rule");
        rule = JSON.parse(rule)

        var topicId = $(this).attr("data-id");

        if(fileObj.size>=rule.max*1024*1024){
            weui.topTips("文件大小限制"+rule.max+"M", 1500);
            return;
        }

        var formData = new FormData();
        formData.append("file", fileObj);
        var fileLoading = weui.loading('上传中...');
        
        // fetch("http://10.110.200.62:443/services/web/file/upload/mallUpload/form",{
        //     method: 'POST',
        //     mode: 'no-cors',
        //     headers: {'Content-Type': 'application/json'},
        //     credentials: 'include',
        //     cache: 'default',
        //     // body: JSON.stringify(formData),
        //     body: formData,
        // }).then(function(res){
        //         res.json().then(data=>{
        //             console.log(res)
        //         })
        //     }).catch(error=>{
        //         console.log(error)
                
        //     })

        $.ajax({ 
            url:IP + "/services/web/file/upload/mallUpload/form", 
            type:"post", 
            // mode: 'no-cors',
            data:formData, 
            contentType:'application/x-www-form-urlencoded;charset=utf-8',
            processData: false ,    // 不处理数据
            contentType: false,    // 不设置内容类型
            success:function(res){ 
                fileLoading.hide();
                if(res.status === 1){ 
                    $(that).css('backgroundImage','url(img/uploadOk.png)')
                    $(".deleteFile-" + topicId).css('display', 'block');
                    $(".field-rule-" + topicId).html('');
                    FormObject["file-" + topicId] = res.root.object[0].filePath;
                }else{
                    weui.topTips(res.errorMsg, 1500);
                }
                console.log(res); 
                
            }, 
            error:function(err){ 
                fileLoading.hide();
                var errorLoading = weui.loading('上传失败');
                setTimeout(function(){
                    errorLoading.hide();
                },1500)
                
            } 
        
        }) 
    })

    //删除附件
    $(document).on('click','.deleteFile',function(){

        var topicId = $(this).attr("data-id");

        var rule = $(this).attr("data-rule");
        console.log(rule)
        if(rule==='true'){
            $(".field-rule-" + topicId).html('必做题');
        }
        FormObject["file-" + topicId] = '';
        $("#file-" + topicId).css('backgroundImage', 'url(img/upload.png)');
        $(this).css('display','none')
    })

    //备注-必填
    $(document).on('input','.field-remark',function(){
        var that = $(this);
        var value = that.val();
        var id = that.attr("data-id");

        var isRequired = that.attr('data-required')

        var order = that.attr('data-order')
        
        
        if(order){
            var remarkObj = {};
            remarkObj = JSON.parse(FormObject["remark-" + id + "_" + order]);
            remarkObj.desp = value;
            FormObject["remark-" + id + "_" + order] = JSON.stringify(remarkObj);
        }else{
            var remarkObj = {};
            remarkObj = JSON.parse(FormObject["remark-" + id + "_1"]);
            remarkObj.desp = value;
            FormObject["remark-" + id + "_1"] = JSON.stringify(remarkObj);
        }

        if(value){
            that.removeClass('remarkRed')
        }else{
            if(isRequired === '1'){
                that.addClass('remarkRed')
            }else{
                that.removeClass('remarkRed')
            }
        }
    })
</script>
<script>

    function submit(){

        var ruleList = [];
        $('.field-rule:visible').each(function() { 
            var text = $(this).text()
            text&&ruleList.push(text)
        });
        console.log(ruleList)
        if(ruleList.length){
            weui.topTips('表单填写不规范或必做题没填', 1500);
            return;
        }

        if($('.remarkRed').length){
            weui.topTips('表单备注没填', 1500);
            return;
        }
        
        

        console.log($('#form').serialize());
        var result = $('#form').serialize().split('&')
        result.map(function(item){
            if(item.indexOf('checkbox')<0&&item.indexOf('select')<0&&item.indexOf('radio')<0){
                var list2 = item.split('=')
                FormObject[list2[0]] = list2[1]||''
            }
        })

        console.log(FormObject)

        var list = [],remarkList = [],allFormData={};
        for(var key in FormObject){
            var regStr = /^remark-[0-9]{19}-[0-9]{1,2}$/;
            if(regStr.test(key)){
                // delete FormObject[key]
            }
            var regStr2 = /^remark-[0-9]{19}_/;
            if(regStr2.test(key)){
                console.log(key)
                // remarkList.push({id:key.substring(7,26),remark:FormObject[key]})
                // delete FormObject[key]
            }
            if(key.indexOf('remark')>-1&&key.indexOf('_')>-1&&FormObject[key]){
                remarkList.push({id:key.substring(7,26),remark:FormObject[key]})
            }
            if(!regStr.test(key)&&!regStr2.test(key)){
                allFormData[key] = FormObject[key]
            }
        }

        console.log(remarkList,FormObject,allFormData)
        
        for(var name in allFormData){
            var formName = name.split('-')[0];
            var formid = name.split('-')[1];
            var content = allFormData[name]
            if(formName==='checkbox'){
                var arr2 = [];
                remarkList.map(function(item){
                    console.log(formid,item)
                    if(formid === item.id&&item.remark){
                        
                        arr2.push(JSON.parse(item.remark))
                    }
                })
                
                list.push({
                    "topicId": formid,
                    "content": content,
                    "remark": arr2.length?JSON.stringify(arr2):''
                })
            }else if(formName==='radio'||formName==='select'){
                var str = '';
                remarkList.map(function(item){
                    if(formid === item.id){
                        str = item.remark
            
                    }
                })
                list.push({
                    "topicId": formid,
                    "content": content,
                    "remark": str
                })
            }else if(formName!=='checkbox'&&formName!=='radio'&&formName!=='select'&&formName!=='remark'){
                list.push({
                    "topicId": formid,
                    "content": decodeURI(String(content)),
                    "remark": ""
                })
            }
            
        }
        console.log(list)
        var body = [];
        topicAllList.map(function(item){
            list.map(function(e){
                if(e.topicId===item.id){
                    body.push(e)
                }
                
            })
        })
        console.log(body)
        var submitUrl = IP + "/services/web/config/questionnaireFormAnswer/commitForm/" + formId + "/" + userId;
        var submitLoading = weui.loading('提交中...');
        $.ajax({
            type:'post',
            url:submitUrl,
            contentType:'application/json;charset=utf-8',
            dataType:'json',
            data:JSON.stringify(body),      
            success:function(data){
                console.log(data)
                submitLoading.hide();
                if(data.status === 1){
                    setTimeout(function(){
                        weui.toast('提交成功', 1200);
                        // window.location.href = 'finish.html?ToAPP=1'
                        window.location.href = IP + "/services/app/static/cicth5/form/finish.html?ToAPP=1";
                    },200)
                }else{
                    weui.topTips(data.errorMsg, 1500);
                }
            },
            error:function(error){

            }
        });   

        
        

        
    }
</script>
</html>